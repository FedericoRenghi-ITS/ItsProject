<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lista Nomi</title>
  <link rel="stylesheet" href="/styles/api.css" />
</head>
<body>
  <section style="display: flex; flex-direction: column;">
  <div >
    <h1 style="text-align: center; padding: 10px;">Lista cose da fare</h1>
  </div>
  <div class="top">
    <div class="input-area"> 
      <input id="inputNome" type="text" placeholder="Aggiungi cosa da fare" />
      <button id="btnMostra">Mostra Lista</button>
      <button id="btnResetta">Resetta</button>
    </div>

  
    <ul id="listaNomi"></ul>
  </div>
</section>
  <script>
    const nomi = [];
    const selezionati = {};
    const inputNome = document.getElementById("inputNome");
    const btnMostra = document.getElementById("btnMostra");
    const btnResetta = document.getElementById("btnResetta");
    const listaNomi = document.getElementById("listaNomi");

    const baseUrl = "https://its-todo-api.azurewebsites.net/api";  //URL dell'api

    let listaVisibile = false; // Stato della visualizzazione

// RICARIMENTO PAGINA

    document.addEventListener("DOMContentLoaded", function () {
      fetchData()
        .then((todos) => {
          if (todos) {
            console.log("Dati ricevuti:", todos);
            todos.forEach((item) => {
              nomi.push(item.description);
            });
          }
        })
        .catch((error) => {
          console.error("Errore durante il fetch dei dati:", error);
        });
    });

//-------------------------------------------------------API--------------------------------------------------------------------
    async function fetchData() {
      //https://its-todo-api.azurewebsites.net
      try {
        const response = await fetch(`${baseUrl}/Todo`, {
          method: "GET",
          headers: {
            "x-api-key": "V4PaperYx4Ycc6zucdO6",
          },
        });

        if (!response.ok) throw new Error("Errore nella risposta");

        const todos = await response.json();
        return todos; // Questo ritorna i dati all'interno della funzione async
      } catch (error) {
        console.error("Errore API:", error);
        return null;
      }
    }

    async function createTodo(description, isCompleted = false) {
      try {
        const response = await fetch(`${baseUrl}/Todo`, {
          method: "POST",
          headers: {
            "x-api-key": "V4PaperYx4Ycc6zucdO6",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            description: description,
            isCompleted: isCompleted,
          }),
        });

        if (!response.ok) {
          const errorData = await response.text();
          console.error("Errore dal server:", response.status, errorData);
        } else {
          console.log("Todo creato con successo");
        }
      } catch (error) {
        console.error("Errore API:", error);
      }
    }

//---------------------------------------------------------------------SITO-----------------------------------------------------------------
    // Aggiunta con il tasto Invio
    inputNome.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        const nome = inputNome.value.trim();
        if (nome !== "") {
          humpscare(nome);
          nomi.push(nome);
          createTodo(nome);
          inputNome.value = "";
          if (listaVisibile) {
            aggiornaLista(); // aggiorna subito se la lista è visibile
          }
        }
        else {
          inputNome.classList.add("animazione")
          setTimeout(() => {
            inputNome.classList.remove("animazione");
            }, 400);
        };
      }
    });

    // Mostra/Nascondi lista
    btnMostra.addEventListener("click", () => {
      listaVisibile = !listaVisibile;
      if (listaVisibile) {
        aggiornaLista();
        btnMostra.textContent = "Nascondi Lista";
      } else {
        listaNomi.innerHTML = "";
        btnMostra.textContent = "Mostra Lista";
      }
    });


    // Aggiornare la lista
    function aggiornaLista() {
      listaNomi.innerHTML = "";
      fetchData().then((todos) => {
        console.log(todos)
        todos.forEach((item) => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.classList.add("nome-btn");

        if (selezionati[item.description]) {
          btn.classList.add("selezionato");
          btn.textContent = "✓ " + item.description;
        } else {
          btn.textContent = item.description;
        }

    btn.addEventListener("click", () => {
      btn.classList.toggle("selezionato");
      if (btn.classList.contains("selezionato")) {
        btn.textContent = "✓ " + item.description;
        selezionati[item.description] = true;
      } else {
        btn.textContent = item.description;
        selezionati[item.description] = false;
      }
    });

    li.appendChild(btn);
    listaNomi.appendChild(li);
      });
  });
}

    /* Funzione che aggiorna il contenuto della lista
    function aggiornaLista() {
      listaNomi.innerHTML = "";
      nomi.forEach((nome) => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.classList.add("nome-btn");

        if (selezionati[nome]) {
          btn.classList.add("selezionato");
          btn.textContent = "✓ " + nome;
        } else {
          btn.textContent = nome;
        }

    btn.addEventListener("click", () => {
      btn.classList.toggle("selezionato");
      if (btn.classList.contains("selezionato")) {
        btn.textContent = "✓ " + nome;
        selezionati[nome] = true;
      } else {
        btn.textContent = nome;
        selezionati[nome] = false;
      }
    });

    li.appendChild(btn);
    listaNomi.appendChild(li);
  });
}*/

    // Reset totale (array + lista visibile)
    btnResetta.addEventListener("click", () => {
      nomi.length = 0;
      listaNomi.innerHTML = "";
      listaVisibile = false;
      btnMostra.textContent = "Mostra Lista";
      for (let key in selezionati) {
        delete selezionati[key];
      }
    });


/*-----------------------------------------------------ERO ANNOIATO------------------------------------------------------------------------------------------------*/

    const effetti = {
          "banana":{ img:"/img/banana.jpg",},
          "boss": {img: "/img/boss.jpg"},
          "miku": {img:"/img/miku.jpg"},
          "goku": {img: "/img/goku.jpg", audio: "/sounds/goku-UI.mp3"}
          
        };


    function humpscare(nome) {
      const defaultAudio = "/sounds/vine-boom.mp3";

      const chiave = nome.toLowerCase();
      const effetto = effetti[chiave];

      if (!effetto) return;

      const pathImg = effetto.img;
      const pathAudio = effetto.audio || defaultAudio;

      // Riproduzione audio
      const audio = new Audio(pathAudio);
      audio.volume = 0.7;
      audio.play();
      setTimeout(() => {
      audio.pause();
      audio.currentTime = 0; // torna all'inizio per eventuale riuso
      }, 1000);
      // Immagine principale
      const img = document.createElement("img");
      img.src = pathImg;
      img.classList.add("humpscare-img");

      // After image
      const after = document.createElement("img");
      after.src = pathImg;
      after.classList.add("humpscare-after");

      document.body.appendChild(after);
      document.body.appendChild(img);

      setTimeout(() => after.remove(), 500);
      setTimeout(() => {
        img.classList.add("hide");
        setTimeout(() => img.remove(), 500);
      }, 2000);
    }
    
  </script>

</body>
</html>